<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<title>Jeu de marchand - Villes & Ressources</title>
		<link rel="stylesheet" href="assets/style.css" />
	</head>
	<body>
		<div id="message-bar"></div>

		<!-- Écran d'accueil -->
		<div id="start-screen">
			<div id="start-card">
				<h1>Marchand de Colonies</h1>
				<p
					>Achète à bas prix dans une ville, vends plus cher dans une
					autre, et fais fortune.</p
				>
				<div class="start-buttons">
					<button id="btn-new-game">Nouvelle partie</button>
					<button id="btn-load-game">Charger la sauvegarde</button>
					<button id="btn-reset-save">Effacer la sauvegarde</button>
				</div>
			</div>
		</div>

		<!-- Écran de jeu -->
		<div id="game-screen" class="hidden">
			<header>
				<div class="title">Marchand de Colonies</div>
				<div style="display: flex; gap: 0.5rem">
					<button id="btn-save-game">Sauvegarder la partie</button>
					<button id="btn-back-menu">Retour au menu</button>
				</div>
			</header>

			<main class="layout">
				<aside id="cities-panel" class="card">
					<h2>Villes</h2>
					<small>Cliquer pour consulter les stocks.</small>
					<div id="cities-list"></div>
				</aside>

				<section id="main-panel">
					<div id="player-panel" class="card">
						<div>
							<h2>Fiche du joueur</h2>
							<div id="player-info"></div>
						</div>
						<div>
							<h3>Cargaison</h3>
							<div id="cargo-list"></div>
						</div>
					</div>

					<div id="city-panel" class="card">
						<h2>Ville sélectionnée</h2>
						<div id="city-details"></div>
					</div>

					<div id="trade-panel" class="card">
						<h2>Commerce dans la ville actuelle</h2>
						<div id="trade-content"></div>
					</div>

					<div id="travel-panel" class="card">
						<h2>Voyage</h2>
						<div id="travel-panel-list"></div>
					</div>
				</section>
			</main>
		</div>

		<!-- Overlay de voyage -->
		<div id="travel-overlay" class="hidden">
			<div class="overlay-content">
				<div id="travel-text">Voyage en cours...</div>
				<div class="progress-bar">
					<div class="progress-bar-inner" id="travel-progress"></div>
				</div>
			</div>
		</div>

		<script>
			const SAVE_KEY = "merchant_save_v1";

			const defaultWorld = {
				ressources: [
					"Cacao",
					"Coton",
					"Pierres précieuses",
					"Raisins",
					"Poudre à canon",
					"Métal",
					"Rations",
					"Pimenter",
					"Canne à sucre",
					"Tabac vieilli",
				],
				villes: {
					Ville_A: {
						stocks: {
							Cacao: { quantite: 923, prix: 22 },
							Coton: { quantite: 626, prix: 23 },
							"Pierres précieuses": { quantite: 316, prix: 373 },
							Raisins: { quantite: 490, prix: 30 },
							"Poudre à canon": { quantite: 547, prix: 87 },
							Métal: { quantite: 272, prix: 37 },
							Rations: { quantite: 737, prix: 44 },
							Pimenter: { quantite: 936, prix: 21 },
							"Canne à sucre": { quantite: 754, prix: 16 },
							"Tabac vieilli": { quantite: 408, prix: 78 },
						},
					},
					Ville_B: {
						stocks: {
							Cacao: { quantite: 575, prix: 29 },
							Coton: { quantite: 569, prix: 24 },
							"Pierres précieuses": { quantite: 385, prix: 364 },
							Raisins: { quantite: 510, prix: 29 },
							"Poudre à canon": { quantite: 502, prix: 89 },
							Métal: { quantite: 695, prix: 32 },
							Rations: { quantite: 593, prix: 47 },
							Pimenter: { quantite: 812, prix: 26 },
							"Canne à sucre": { quantite: 709, prix: 17 },
							"Tabac vieilli": { quantite: 429, prix: 77 },
						},
					},
					Ville_C: {
						stocks: {
							Cacao: { quantite: 890, prix: 25 },
							Coton: { quantite: 469, prix: 25 },
							"Pierres précieuses": { quantite: 502, prix: 349 },
							Raisins: { quantite: 606, prix: 28 },
							"Poudre à canon": { quantite: 473, prix: 91 },
							Métal: { quantite: 267, prix: 37 },
							Rations: { quantite: 572, prix: 48 },
							Pimenter: { quantite: 0, prix: 40 },
							"Canne à sucre": { quantite: 734, prix: 17 },
							"Tabac vieilli": { quantite: 173, prix: 76 },
						},
					},
					Ville_D: {
						stocks: {
							Cacao: { quantite: 992, prix: 15 },
							Coton: { quantite: 618, prix: 23 },
							"Pierres précieuses": { quantite: 384, prix: 364 },
							Raisins: { quantite: 552, prix: 29 },
							"Poudre à canon": { quantite: 694, prix: 80 },
							Métal: { quantite: 506, prix: 34 },
							Rations: { quantite: 533, prix: 49 },
							Pimenter: { quantite: 1638.23, prix: 15 },
							"Canne à sucre": { quantite: 536, prix: 19 },
							"Tabac vieilli": { quantite: 510, prix: 73 },
						},
					},
				},
				routes: {
					Ville_A: {
						Ville_B: { temps: 8000, cout: 40 },
						Ville_C: { temps: 12000, cout: 70 },
						Ville_D: { temps: 10000, cout: 60 },
					},
					Ville_B: {
						Ville_A: { temps: 8000, cout: 40 },
						Ville_C: { temps: 7000, cout: 35 },
						Ville_D: { temps: 15000, cout: 90 },
					},
					Ville_C: {
						Ville_A: { temps: 12000, cout: 70 },
						Ville_B: { temps: 7000, cout: 35 },
						Ville_D: { temps: 9000, cout: 55 },
					},
					Ville_D: {
						Ville_A: { temps: 10000, cout: 60 },
						Ville_B: { temps: 15000, cout: 90 },
						Ville_C: { temps: 9000, cout: 55 },
					},
				},
			};

			let gameState = null;
			let selectedCityName = null;
			let travelIntervalId = null;

			const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

			function randomCityName() {
				const keys = Object.keys(defaultWorld.villes);
				return keys[Math.floor(Math.random() * keys.length)];
			}

			function computeReduction(level) {
				return Math.min(0.5, level * 0.02); // 2% par niveau, max 50%
			}

			function formatOr(value) {
				return value.toLocaleString("fr-FR", {
					minimumFractionDigits: 0,
					maximumFractionDigits: 2,
				});
			}

			function showMessage(text) {
				const bar = document.getElementById("message-bar");
				bar.textContent = text;
				bar.classList.add("visible");
				setTimeout(() => bar.classList.remove("visible"), 2000);
			}

			function clearElement(el) {
				el.textContent = "";
			}

			function loadGameFromStorage() {
				const raw = localStorage.getItem(SAVE_KEY);
				if (!raw) return null;
				try {
					const state = JSON.parse(raw);

					// Nettoyage d'un voyage mal formé ou déjà terminé
					if (state.voyage) {
						const v = state.voyage;
						const now = Date.now();

						if (
							!v.startTime ||
							!v.tempsTotal ||
							isNaN(v.startTime) ||
							isNaN(v.tempsTotal)
						) {
							if (v.arrivee && state.joueur) {
								state.joueur.villeActuelle = v.arrivee;
							}
							state.voyage = null;
						} else {
							const elapsed = now - v.startTime;
							if (elapsed >= v.tempsTotal) {
								if (v.arrivee && state.joueur) {
									state.joueur.villeActuelle = v.arrivee;
								}
								state.voyage = null;
							}
						}
					}

					if (!state.joueur) {
						return null;
					}
					if (!state.joueur.niveau) state.joueur.niveau = 1;
					state.joueur.reductionVoyage = computeReduction(
						state.joueur.niveau
					);

					localStorage.setItem(SAVE_KEY, JSON.stringify(state));
					return state;
				} catch (e) {
					console.error("Erreur de chargement :", e);
					return null;
				}
			}

			function createNewGameState() {
				const startCity = randomCityName();
				const cargaison = {};
				defaultWorld.ressources.forEach((r) => (cargaison[r] = 0));

				const joueur = {
					nom: "Marchand",
					villeActuelle: startCity,
					or: 1000,
					cargaison,
					niveau: 1,
					xp: 0,
					reductionVoyage: 0,
				};
				joueur.reductionVoyage = computeReduction(joueur.niveau);

				return {
					ressources: defaultWorld.ressources.slice(),
					villes: deepClone(defaultWorld.villes),
					routes: deepClone(defaultWorld.routes),
					joueur,
					voyage: null,
				};
			}

			function saveGame(showMsg = true) {
				if (!gameState) return;
				localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
				if (showMsg) showMessage("Partie sauvegardée.");
			}

			function renderAll() {
				if (!gameState) return;
				if (!selectedCityName || !gameState.villes[selectedCityName]) {
					selectedCityName = gameState.joueur.villeActuelle;
				}
				renderPlayerPanel();
				renderCitiesList();
				renderCityDetails(selectedCityName);
				renderTradePanel();
				renderTravelPanel();
			}

			function renderPlayerPanel() {
				const j = gameState.joueur;
				const info = document.getElementById("player-info");
				clearElement(info);

				const lines = [
					`Nom : ${j.nom}`,
					`Ville actuelle : ${j.villeActuelle}`,
					`Or : ${formatOr(j.or)}`,
					`Niveau : ${j.niveau}`,
					`XP : ${j.xp}`,
					`Réduction voyage : ${(j.reductionVoyage * 100).toFixed(0)} %`,
				];

				lines.forEach((text) => {
					const div = document.createElement("div");
					div.textContent = text;
					info.appendChild(div);
				});

				const cargoDiv = document.getElementById("cargo-list");
				clearElement(cargoDiv);
				const ul = document.createElement("ul");

				gameState.ressources.forEach((r) => {
					const li = document.createElement("li");
					const q = j.cargaison[r] || 0;
					li.textContent = `${r} : ${q}`;
					ul.appendChild(li);
				});

				cargoDiv.appendChild(ul);
			}

			function renderCitiesList() {
				const list = document.getElementById("cities-list");
				clearElement(list);
				const current = gameState.joueur.villeActuelle;

				Object.keys(gameState.villes).forEach((name) => {
					const btn = document.createElement("button");
					btn.className = "city-btn";
					btn.textContent = name;
					if (name === current) btn.classList.add("current-city");
					if (name === selectedCityName)
						btn.classList.add("selected-city");
					btn.addEventListener("click", () => {
						selectedCityName = name;
						renderAll();
					});
					list.appendChild(btn);
				});
			}

			function renderCityDetails(cityName) {
				const container = document.getElementById("city-details");
				clearElement(container);
				const ville = gameState.villes[cityName];
				if (!ville) {
					container.textContent = "Ville inconnue.";
					return;
				}
				const isCurrent = cityName === gameState.joueur.villeActuelle;
				const h3 = document.createElement("h3");
				h3.textContent = isCurrent
					? `${cityName} (ville actuelle)`
					: cityName;
				container.appendChild(h3);

				const table = document.createElement("table");
				const thead = document.createElement("thead");
				const trHead = document.createElement("tr");
				const thRes = document.createElement("th");
				thRes.textContent = "Ressource";
				const thQ = document.createElement("th");
				thQ.textContent = "Quantité";
				const thP = document.createElement("th");
				thP.textContent = "Prix d'achat";
				trHead.appendChild(thRes);
				trHead.appendChild(thQ);
				trHead.appendChild(thP);
				thead.appendChild(trHead);
				table.appendChild(thead);

				const tbody = document.createElement("tbody");

				gameState.ressources.forEach((res) => {
					const info = ville.stocks[res];
					if (!info) return;
					const tr = document.createElement("tr");
					const tdRes = document.createElement("td");
					const tdQ = document.createElement("td");
					const tdP = document.createElement("td");
					tdRes.textContent = res;
					tdQ.textContent = info.quantite.toLocaleString("fr-FR");
					tdP.textContent = info.prix.toLocaleString("fr-FR");
					tr.appendChild(tdRes);
					tr.appendChild(tdQ);
					tr.appendChild(tdP);
					tbody.appendChild(tr);
				});

				table.appendChild(tbody);
				container.appendChild(table);
			}

			function renderTradePanel() {
				const tradeDiv = document.getElementById("trade-content");
				clearElement(tradeDiv);
				const j = gameState.joueur;
				const canTrade = !gameState.voyage;

				const p = document.createElement("p");
				p.textContent = `Vous pouvez commercer uniquement dans ${j.villeActuelle}.`;
				tradeDiv.appendChild(p);

				const form = document.createElement("form");
				form.id = "trade-form";
				form.addEventListener("submit", (event) => event.preventDefault());

				// Choix ressource
				const groupRes = document.createElement("div");
				const labelRes = document.createElement("label");
				labelRes.setAttribute("for", "trade-resource");
				labelRes.textContent = "Ressource";
				const selectRes = document.createElement("select");
				selectRes.id = "trade-resource";
				gameState.ressources.forEach((r) => {
					const opt = document.createElement("option");
					opt.value = r;
					opt.textContent = r;
					selectRes.appendChild(opt);
				});
				groupRes.appendChild(labelRes);
				groupRes.appendChild(selectRes);

				// Quantité
				const groupQty = document.createElement("div");
				const labelQty = document.createElement("label");
				labelQty.setAttribute("for", "trade-quantity");
				labelQty.textContent = "Quantité";
				const inputQty = document.createElement("input");
				inputQty.type = "number";
				inputQty.id = "trade-quantity";
				inputQty.min = "1";
				inputQty.value = "1";
				groupQty.appendChild(labelQty);
				groupQty.appendChild(inputQty);

				// Bouton acheter
				const groupBuy = document.createElement("div");
				const btnBuy = document.createElement("button");
				btnBuy.id = "btn-acheter";
				btnBuy.type = "button";
				btnBuy.textContent = "Acheter";
				groupBuy.appendChild(btnBuy);

				// Bouton vendre
				const groupSell = document.createElement("div");
				const btnSell = document.createElement("button");
				btnSell.id = "btn-vendre";
				btnSell.type = "button";
				btnSell.textContent = "Vendre";
				groupSell.appendChild(btnSell);

				form.appendChild(groupRes);
				form.appendChild(groupQty);
				form.appendChild(groupBuy);
				form.appendChild(groupSell);
				tradeDiv.appendChild(form);

				const hint = document.createElement("small");
				hint.id = "trade-hint";
				tradeDiv.appendChild(hint);

				function updateHint() {
					const res = selectRes.value;
					const qty = Number(inputQty.value) || 0;
					const ville = gameState.villes[j.villeActuelle];
					const info = ville.stocks[res];
					const prix = info.prix;
					const total = prix * qty;
					const stockVille = info.quantite;
					const cargo = j.cargaison[res] || 0;
					hint.textContent =
						`Prix unitaire : ${prix.toLocaleString("fr-FR")} | ` +
						`Coût total (achat) : ${total.toLocaleString("fr-FR")} | ` +
						`Stock ville : ${stockVille.toLocaleString("fr-FR")} | ` +
						`Vous : ${cargo}`;
				}

				selectRes.addEventListener("change", updateHint);
				inputQty.addEventListener("input", updateHint);
				updateHint();

				btnBuy.addEventListener("click", () => {
					doTrade("buy", selectRes.value, inputQty.value);
				});
				btnSell.addEventListener("click", () => {
					doTrade("sell", selectRes.value, inputQty.value);
				});

				if (!canTrade) {
					const controls = tradeDiv.querySelectorAll(
						"input, select, button"
					);
					controls.forEach((el) => (el.disabled = true));
					hint.textContent = "Impossible de commercer pendant un voyage.";
				}
			}

			function renderTravelPanel() {
				const panel = document.getElementById("travel-panel-list");
				clearElement(panel);
				const j = gameState.joueur;
				const routesFrom = gameState.routes[j.villeActuelle] || {};
				const isTraveling = !!gameState.voyage;

				const routeNames = Object.keys(routesFrom);
				if (routeNames.length === 0) {
					const div = document.createElement("div");
					div.textContent = "Aucune route depuis cette ville.";
					panel.appendChild(div);
					return;
				}

				routeNames.forEach((dest) => {
					const route = routesFrom[dest];
					const wrap = document.createElement("div");
					wrap.className = "travel-item";

					const strong = document.createElement("strong");
					strong.textContent = dest;
					wrap.appendChild(strong);

					const tempsSec = (route.temps / 1000).toFixed(1);
					const coutBase = route.cout;
					const coutReel = Math.round(coutBase * (1 - j.reductionVoyage));

					const lineTime = document.createElement("div");
					lineTime.textContent = `Temps : ${tempsSec} s`;
					const lineCost = document.createElement("div");
					lineCost.textContent = `Coût : ${coutReel.toLocaleString(
						"fr-FR"
					)} or (base ${coutBase})`;

					wrap.appendChild(lineTime);
					wrap.appendChild(lineCost);

					const lineBtn = document.createElement("div");
					lineBtn.style.marginTop = ".3rem";
					const btn = document.createElement("button");
					btn.textContent = "Voyager";
					btn.dataset.dest = dest;
					if (isTraveling) btn.disabled = true;
					btn.addEventListener("click", () => {
						startTravel(dest);
					});
					lineBtn.appendChild(btn);
					wrap.appendChild(lineBtn);

					panel.appendChild(wrap);
				});
			}

			function addXp(amount) {
				const j = gameState.joueur;
				j.xp += amount;
				const oldLevel = j.niveau;
				j.niveau = 1 + Math.floor(j.xp / 100);
				if (j.niveau !== oldLevel) {
					j.reductionVoyage = computeReduction(j.niveau);
					showMessage(
						`Niveau ${j.niveau} atteint ! Réduction de voyage : ${(
							j.reductionVoyage * 100
						).toFixed(0)} %`
					);
				}
			}

			function doTrade(type, res, qtyStr) {
				if (gameState.voyage) {
					showMessage("Vous ne pouvez pas commercer pendant un voyage.");
					return;
				}
				const j = gameState.joueur;
				const ville = gameState.villes[j.villeActuelle];
				const qty = Math.max(1, Number(qtyStr) || 0);
				const info = ville.stocks[res];

				if (!info) {
					showMessage("Ressource inconnue.");
					return;
				}

				if (type === "buy") {
					const totalCost = info.prix * qty;
					if (info.quantite < qty) {
						showMessage("Stock insuffisant dans la ville.");
						return;
					}
					if (j.or < totalCost) {
						showMessage("Vous n'avez pas assez d'or.");
						return;
					}
					info.quantite -= qty;
					j.or -= totalCost;
					j.cargaison[res] = (j.cargaison[res] || 0) + qty;
					addXp(qty);
					showMessage(`Achat de ${qty} ${res}.`);
				} else {
					const cargoQty = j.cargaison[res] || 0;
					if (cargoQty < qty) {
						showMessage("Vous n'avez pas assez de marchandise à vendre.");
						return;
					}
					const totalGain = info.prix * qty;
					info.quantite += qty;
					j.cargaison[res] = cargoQty - qty;
					j.or += totalGain;
					addXp(qty);
					showMessage(`Vente de ${qty} ${res}.`);
				}

				saveGame(false);
				renderAll();
			}

			function startTravel(destination) {
				const j = gameState.joueur;
				const from = j.villeActuelle;
				if (from === destination) return;

				const routesFrom = gameState.routes[from] || {};
				const route = routesFrom[destination];
				if (!route) {
					showMessage("Aucune route disponible.");
					return;
				}
				if (gameState.voyage) {
					showMessage("Un voyage est déjà en cours.");
					return;
				}

				const coutBase = route.cout;
				const coutReel = Math.round(coutBase * (1 - j.reductionVoyage));
				if (j.or < coutReel) {
					showMessage("Pas assez d'or pour ce voyage.");
					return;
				}

				j.or -= coutReel;

				const now = Date.now();
				gameState.voyage = {
					depart: from,
					arrivee: destination,
					tempsTotal: route.temps,
					startTime: now,
				};

				saveGame(false);
				showTravelOverlay();

				if (travelIntervalId) clearInterval(travelIntervalId);
				travelIntervalId = setInterval(updateTravelProgress, 100);
				renderAll();
			}

			function showTravelOverlay() {
				const overlay = document.getElementById("travel-overlay");
				overlay.classList.remove("hidden");
				updateTravelProgress();
			}

			function hideTravelOverlay() {
				const overlay = document.getElementById("travel-overlay");
				overlay.classList.add("hidden");
				const bar = document.getElementById("travel-progress");
				bar.style.width = "0%";
			}

			function updateTravelProgress() {
				const v = gameState && gameState.voyage;
				if (!v) {
					hideTravelOverlay();
					if (travelIntervalId) clearInterval(travelIntervalId);
					return;
				}

				const now = Date.now();
				let ratio = (now - v.startTime) / v.tempsTotal;
				if (ratio < 0) ratio = 0;
				if (ratio > 1) ratio = 1;

				const bar = document.getElementById("travel-progress");
				const text = document.getElementById("travel-text");

				bar.style.width = ratio * 100 + "%";
				text.textContent = `Voyage de ${v.depart} vers ${
					v.arrivee
				} : ${Math.round(ratio * 100)} %`;

				if (ratio >= 1) {
					if (travelIntervalId) {
						clearInterval(travelIntervalId);
						travelIntervalId = null;
					}
					finishTravel();
				}
			}

			function finishTravel() {
				const v = gameState.voyage;
				if (!v) return;
				gameState.joueur.villeActuelle = v.arrivee;
				gameState.voyage = null;
				selectedCityName = v.arrivee;
				hideTravelOverlay();
				saveGame(false);
				showMessage(`Arrivé à ${v.arrivee}.`);
				renderAll();
			}

			function switchToGameScreen() {
				document.getElementById("start-screen").classList.add("hidden");
				document.getElementById("game-screen").classList.remove("hidden");
				renderAll();

				if (gameState.voyage) {
					showTravelOverlay();
					if (travelIntervalId) clearInterval(travelIntervalId);
					travelIntervalId = setInterval(updateTravelProgress, 100);
				}
			}

			function switchToStartScreen() {
				document.getElementById("game-screen").classList.add("hidden");
				document.getElementById("start-screen").classList.remove("hidden");
				hideTravelOverlay();
			}

			document.addEventListener("DOMContentLoaded", () => {
				document.getElementById("travel-overlay").classList.add("hidden");

				const btnNew = document.getElementById("btn-new-game");
				const btnLoad = document.getElementById("btn-load-game");
				const btnReset = document.getElementById("btn-reset-save");
				const btnSave = document.getElementById("btn-save-game");
				const btnBack = document.getElementById("btn-back-menu");

				const existingSave = loadGameFromStorage();
				if (!existingSave) {
					btnLoad.disabled = true;
				}

				btnNew.addEventListener("click", () => {
					gameState = createNewGameState();
					selectedCityName = gameState.joueur.villeActuelle;
					saveGame(false);
					switchToGameScreen();
				});

				btnLoad.addEventListener("click", () => {
					const state = loadGameFromStorage();
					if (!state) {
						showMessage("Aucune sauvegarde trouvée.");
						return;
					}
					gameState = state;
					selectedCityName = gameState.joueur.villeActuelle;
					switchToGameScreen();
				});

				btnReset.addEventListener("click", () => {
					localStorage.removeItem(SAVE_KEY);
					showMessage("Sauvegarde effacée.");
					btnLoad.disabled = true;
				});

				btnSave.addEventListener("click", () => {
					saveGame(true);
				});

				btnBack.addEventListener("click", () => {
					switchToStartScreen();
				});
			});
		</script>
	</body>
</html>
