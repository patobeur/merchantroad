<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<title>Éditeur de carte – Space Dealer</title>
		<style>
			* {
				box-sizing: border-box;
			}
			body {
				margin: 0;
				font-family: system-ui, -apple-system, BlinkMacSystemFont,
					"Segoe UI", sans-serif;
				background: #101010;
				color: #eee;
			}

			header {
				background: #181818;
				padding: 0.6rem 1rem;
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-bottom: 1px solid #333;
			}

			header h1 {
				margin: 0;
				font-size: 1.2rem;
			}

			button {
				cursor: pointer;
				border: none;
				padding: 0.35rem 0.7rem;
				border-radius: 4px;
				background: #444;
				color: #fff;
				font-size: 0.85rem;
				margin-left: 0.25rem;
				transition: background 0.15s, transform 0.05s;
			}
			button:hover:not(:disabled) {
				background: #666;
			}
			button:active:not(:disabled) {
				transform: scale(0.97);
			}
			button:disabled {
				opacity: 0.4;
				cursor: not-allowed;
			}

			main {
				display: grid;
				grid-template-columns: 2fr 3fr;
				gap: 1rem;
				padding: 1rem;
				min-height: calc(100vh - 56px);
			}

			.card {
				background: #181818;
				border-radius: 8px;
				padding: 0.7rem 0.8rem;
				border: 1px solid #333;
				display: flex;
				flex-direction: column;
			}

			.card h2,
			.card h3 {
				margin: 0 0 0.5rem;
				font-size: 1rem;
			}

			#map-canvas {
				border-radius: 6px;
				border: 1px solid #333;
				background: #050709;
				width: 100%;
				height: 100%;
				max-height: 520px;
			}

			#map-help {
				margin-top: 0.4rem;
				font-size: 0.8rem;
				color: #ccc;
			}

			.right-column {
				display: flex;
				flex-direction: column;
				gap: 0.7rem;
			}

			#cities-list {
				display: flex;
				flex-wrap: wrap;
				gap: 0.3rem;
				margin-bottom: 0.4rem;
			}

			.city-pill {
				padding: 0.2rem 0.45rem;
				border-radius: 999px;
				border: 1px solid #444;
				background: #252525;
				font-size: 0.8rem;
			}
			.city-pill.selected {
				border-color: #4fc3f7;
				background: #08384c;
			}

			label {
				font-size: 0.8rem;
				display: block;
				margin-bottom: 0.1rem;
			}

			input[type="text"],
			input[type="number"],
			input[type="color"] {
				width: 100%;
				padding: 0.25rem 0.35rem;
				border-radius: 4px;
				border: 1px solid #444;
				background: #101010;
				color: #eee;
				font-size: 0.8rem;
				margin-bottom: 0.35rem;
			}

			.inline-inputs {
				display: grid;
				grid-template-columns: repeat(2, minmax(0, 1fr));
				gap: 0.35rem;
			}

			#resources-list,
			#routes-meta {
				font-size: 0.8rem;
			}

			.resource-row {
				display: flex;
				align-items: center;
				gap: 0.25rem;
				margin-bottom: 0.25rem;
			}

			.resource-row input[type="text"] {
				flex: 1;
				margin-bottom: 0;
			}

			#message-bar {
				position: fixed;
				bottom: 10px;
				right: 10px;
				background: #263238;
				color: #fff;
				padding: 0.4rem 0.7rem;
				border-radius: 4px;
				font-size: 0.8rem;
				opacity: 0;
				pointer-events: none;
				transition: opacity 0.15s;
				z-index: 1500;
			}
			#message-bar.visible {
				opacity: 1;
			}

			small {
				color: #aaa;
			}

			.section-header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				margin-bottom: 0.3rem;
			}
		</style>
	</head>
	<body>
		<div id="message-bar"></div>

		<header>
			<h1>Éditeur de carte – Space Dealer</h1>
			<div>
				<button id="btn-new-config">Nouvelle configuration</button>
				<button id="btn-load-config">Charger configuration</button>
				<button id="btn-save-config">Sauvegarder configuration</button>
				<button id="btn-export-config">Exporter JSON</button>
				<button id="btn-go-game" onclick="window.location.href='index.html'"
					>Aller au jeu</button
				>
			</div>
		</header>

		<main>
			<!-- Carte -->
			<section class="card">
				<h2>Carte (grille)</h2>
				<canvas id="map-canvas" width="640" height="400"></canvas>
				<div id="map-help">
					Clic sur une ville pour la sélectionner. Avec une ville
					sélectionnée, changer X/Y dans le formulaire pour la déplacer.
				</div>
			</section>

			<!-- Panneaux de droite -->
			<section class="right-column">
				<!-- Villes -->
				<div class="card">
					<div class="section-header">
						<h2>Villes</h2>
						<button id="btn-add-city">+ Ajouter une ville</button>
					</div>
					<div id="cities-list"></div>
					<div id="city-form-container"></div>
				</div>

				<!-- Ressources -->
				<div class="card">
					<div class="section-header">
						<h2>Ressources</h2>
						<button id="btn-add-resource">+ Ajouter ressource</button>
					</div>
					<small
						>Ces noms seront utilisés par le jeu. Toute ville doit avoir
						ces ressources dans ses stocks.</small
					>
					<div id="resources-list"></div>
				</div>

				<!-- Routes / Meta -->
				<div class="card">
					<div class="section-header">
						<h2>Routes / Paramètres</h2>
						<button id="btn-recalc-routes">Recalculer les routes</button>
					</div>
					<div id="routes-meta"></div>
					<small
						>Les routes sont calculées automatiquement en fonction de la
						distance entre les villes.</small
					>
				</div>
			</section>
		</main>

		<script>
			// --- Constantes et état global ---------------------------------------
			const WORLD_KEY = "merchant_world_config_v1";

			let worldConfig = null;
			let selectedCityName = null;

			function showMessage(text) {
				const bar = document.getElementById("message-bar");
				bar.textContent = text;
				bar.classList.add("visible");
				setTimeout(() => bar.classList.remove("visible"), 1800);
			}

			function clearElement(el) {
				el.textContent = "";
			}

			// --- Configuration par défaut ----------------------------------------
			function createDefaultWorldConfig() {
				// Même structure que ton jeu, avec position sur la carte
				return {
					ressources: [
						"Cacao",
						"Coton",
						"Pierres précieuses",
						"Raisins",
						"Poudre à canon",
						"Métal",
						"Rations",
						"Pimenter",
						"Canne à sucre",
						"Tabac vieilli",
					],
					villes: {
						Ville_A: {
							x: 5,
							y: 5,
							couleur: "#ffcc00",
							stocks: {
								Cacao: { quantite: 923, prix: 22 },
								Coton: { quantite: 626, prix: 23 },
								"Pierres précieuses": { quantite: 316, prix: 373 },
								Raisins: { quantite: 490, prix: 30 },
								"Poudre à canon": { quantite: 547, prix: 87 },
								Métal: { quantite: 272, prix: 37 },
								Rations: { quantite: 737, prix: 44 },
								Pimenter: { quantite: 936, prix: 21 },
								"Canne à sucre": { quantite: 754, prix: 16 },
								"Tabac vieilli": { quantite: 408, prix: 78 },
							},
						},
						Ville_B: {
							x: 20,
							y: 7,
							couleur: "#4fc3f7",
							stocks: {
								Cacao: { quantite: 575, prix: 29 },
								Coton: { quantite: 569, prix: 24 },
								"Pierres précieuses": { quantite: 385, prix: 364 },
								Raisins: { quantite: 510, prix: 29 },
								"Poudre à canon": { quantite: 502, prix: 89 },
								Métal: { quantite: 695, prix: 32 },
								Rations: { quantite: 593, prix: 47 },
								Pimenter: { quantite: 812, prix: 26 },
								"Canne à sucre": { quantite: 709, prix: 17 },
								"Tabac vieilli": { quantite: 429, prix: 77 },
							},
						},
						Ville_C: {
							x: 10,
							y: 15,
							couleur: "#81c784",
							stocks: {
								Cacao: { quantite: 890, prix: 25 },
								Coton: { quantite: 469, prix: 25 },
								"Pierres précieuses": { quantite: 502, prix: 349 },
								Raisins: { quantite: 606, prix: 28 },
								"Poudre à canon": { quantite: 473, prix: 91 },
								Métal: { quantite: 267, prix: 37 },
								Rations: { quantite: 572, prix: 48 },
								Pimenter: { quantite: 0, prix: 40 },
								"Canne à sucre": { quantite: 734, prix: 17 },
								"Tabac vieilli": { quantite: 173, prix: 76 },
							},
						},
						Ville_D: {
							x: 25,
							y: 18,
							couleur: "#ff8a65",
							stocks: {
								Cacao: { quantite: 992, prix: 15 },
								Coton: { quantite: 618, prix: 23 },
								"Pierres précieuses": { quantite: 384, prix: 364 },
								Raisins: { quantite: 552, prix: 29 },
								"Poudre à canon": { quantite: 694, prix: 80 },
								Métal: { quantite: 506, prix: 34 },
								Rations: { quantite: 533, prix: 49 },
								Pimenter: { quantite: 1638.23, prix: 15 },
								"Canne à sucre": { quantite: 536, prix: 19 },
								"Tabac vieilli": { quantite: 510, prix: 73 },
							},
						},
					},
					routes: {}, // sera recalculé
					meta: {
						gridWidth: 32,
						gridHeight: 20,
						distanceTimeFactor: 400, // ms par unité de distance
						distanceCostFactor: 2, // or par unité de distance
					},
				};
			}

			// --- LocalStorage -----------------------------------------------------
			function loadWorldConfig() {
				const raw = localStorage.getItem(WORLD_KEY);
				if (!raw) return null;
				try {
					const cfg = JSON.parse(raw);
					return cfg;
				} catch (e) {
					console.error("Erreur de parsing config :", e);
					return null;
				}
			}

			function saveWorldConfig(show = true) {
				localStorage.setItem(WORLD_KEY, JSON.stringify(worldConfig));
				if (show) showMessage("Configuration sauvegardée.");
			}

			// --- Utils métiers ----------------------------------------------------
			function ensureCityStocksFollowResources() {
				const resList = worldConfig.ressources;
				const resSet = new Set(resList);
				Object.values(worldConfig.villes).forEach((ville) => {
					if (!ville.stocks) ville.stocks = {};
					// Ajouter manquantes
					resList.forEach((r) => {
						if (!ville.stocks[r]) {
							ville.stocks[r] = { quantite: 0, prix: 10 };
						}
					});
					// Supprimer celles qui ne sont plus dans la liste
					Object.keys(ville.stocks).forEach((key) => {
						if (!resSet.has(key)) {
							delete ville.stocks[key];
						}
					});
				});
			}

			function calcDistance(a, b) {
				const dx = (a.x ?? 0) - (b.x ?? 0);
				const dy = (a.y ?? 0) - (b.y ?? 0);
				return Math.sqrt(dx * dx + dy * dy);
			}

			function recalcRoutes() {
				worldConfig.routes = {};
				const names = Object.keys(worldConfig.villes);
				const meta = worldConfig.meta;
				for (let i = 0; i < names.length; i++) {
					for (let j = i + 1; j < names.length; j++) {
						const n1 = names[i];
						const n2 = names[j];
						const v1 = worldConfig.villes[n1];
						const v2 = worldConfig.villes[n2];
						const d = calcDistance(v1, v2);
						const t = Math.round(d * meta.distanceTimeFactor);
						const c = Math.round(d * meta.distanceCostFactor);

						if (!worldConfig.routes[n1]) worldConfig.routes[n1] = {};
						if (!worldConfig.routes[n2]) worldConfig.routes[n2] = {};
						worldConfig.routes[n1][n2] = { temps: t, cout: c };
						worldConfig.routes[n2][n1] = { temps: t, cout: c };
					}
				}
			}

			function getUniqueCityName(base) {
				let idx = 1;
				let name = base;
				while (worldConfig.villes[name]) {
					idx++;
					name = base + "_" + idx;
				}
				return name;
			}

			// --- Rendu carte ------------------------------------------------------
			function renderMap() {
				const canvas = document.getElementById("map-canvas");
				const ctx = canvas.getContext("2d");

				const w = canvas.width;
				const h = canvas.height;
				const meta = worldConfig.meta;
				const cellW = w / meta.gridWidth;
				const cellH = h / meta.gridHeight;

				// fond
				ctx.fillStyle = "#050709";
				ctx.fillRect(0, 0, w, h);

				// grille
				ctx.strokeStyle = "#222";
				ctx.lineWidth = 1;
				ctx.beginPath();
				for (let x = 0; x <= meta.gridWidth; x++) {
					const px = x * cellW;
					ctx.moveTo(px, 0);
					ctx.lineTo(px, h);
				}
				for (let y = 0; y <= meta.gridHeight; y++) {
					const py = y * cellH;
					ctx.moveTo(0, py);
					ctx.lineTo(w, py);
				}
				ctx.stroke();

				// villes
				Object.entries(worldConfig.villes).forEach(([name, ville]) => {
					const cx = (ville.x + 0.5) * cellW;
					const cy = (ville.y + 0.5) * cellH;
					const radius = Math.min(cellW, cellH) * 0.35;

					const color = ville.couleur || "#ffd54f";
					ctx.beginPath();
					ctx.arc(cx, cy, radius, 0, Math.PI * 2);
					ctx.fillStyle = color;
					ctx.fill();

					if (name === selectedCityName) {
						ctx.lineWidth = 3;
						ctx.strokeStyle = "#4fc3f7";
						ctx.stroke();
					}

					ctx.fillStyle = "#000";
					ctx.font = `${Math.round(radius)}px system-ui`;
					ctx.textAlign = "center";
					ctx.textBaseline = "middle";
					ctx.fillText(name[0] || "?", cx, cy);
				});
			}

			function handleCanvasClick(evt) {
				const canvas = document.getElementById("map-canvas");
				const rect = canvas.getBoundingClientRect();

				// Corrige la position du clic en fonction de la mise à l'échelle du canvas
				const scaleX = canvas.width / rect.width;
				const scaleY = canvas.height / rect.height;
				const x = (evt.clientX - rect.left) * scaleX;
				const y = (evt.clientY - rect.top) * scaleY;

				const meta = worldConfig.meta;
				const cellW = canvas.width / meta.gridWidth;
				const cellH = canvas.height / meta.gridHeight;

				const gx = Math.floor(x / cellW);
				const gy = Math.floor(y / cellH);

				// Empêche le placement hors des limites de la grille
				if (
					gx < 0 ||
					gx >= meta.gridWidth ||
					gy < 0 ||
					gy >= meta.gridHeight
				) {
					return; // Clic en dehors de la grille
				}

				// si on clique sur une ville -> sélection
				let clickedCity = null;
				Object.entries(worldConfig.villes).forEach(([name, ville]) => {
					if (ville.x === gx && ville.y === gy) {
						clickedCity = name;
					}
				});

				if (clickedCity) {
					selectedCityName = clickedCity;
					renderAll();
					return;
				}

				// si une ville est sélectionnée -> déplacer cette ville
				if (selectedCityName) {
					const ville = worldConfig.villes[selectedCityName];
					ville.x = gx;
					ville.y = gy;
					showMessage(`Ville déplacée en (${gx}, ${gy}).`);
					recalcRoutes();
					renderAll();
				}
			}

			// --- Panneau villes ---------------------------------------------------
			function renderCitiesPanel() {
				const listDiv = document.getElementById("cities-list");
				const formContainer = document.getElementById(
					"city-form-container"
				);
				clearElement(listDiv);
				clearElement(formContainer);

				const names = Object.keys(worldConfig.villes);
				names.forEach((name) => {
					const pill = document.createElement("button");
					pill.className = "city-pill";
					pill.type = "button";
					pill.textContent = name;
					if (name === selectedCityName) pill.classList.add("selected");
					pill.addEventListener("click", () => {
						selectedCityName = name;
						renderAll();
					});
					listDiv.appendChild(pill);
				});

				if (!selectedCityName || !worldConfig.villes[selectedCityName]) {
					const info = document.createElement("div");
					info.textContent = "Sélectionnez une ville pour la modifier.";
					formContainer.appendChild(info);
					return;
				}

				const ville = worldConfig.villes[selectedCityName];

				const title = document.createElement("h3");
				title.textContent = `Édition : ${selectedCityName}`;
				formContainer.appendChild(title);

				// Nom
				const labelName = document.createElement("label");
				labelName.textContent = "Nom de la ville";
				const inputName = document.createElement("input");
				inputName.type = "text";
				inputName.value = selectedCityName;
				formContainer.appendChild(labelName);
				formContainer.appendChild(inputName);

				// Position
				const posWrap = document.createElement("div");
				posWrap.className = "inline-inputs";

				const labelX = document.createElement("label");
				labelX.textContent = "X";
				const inputX = document.createElement("input");
				inputX.type = "number";
				inputX.value = ville.x ?? 0;
				inputX.min = 0;
				inputX.max = worldConfig.meta.gridWidth - 1;

				const labelY = document.createElement("label");
				labelY.textContent = "Y";
				const inputY = document.createElement("input");
				inputY.type = "number";
				inputY.value = ville.y ?? 0;
				inputY.min = 0;
				inputY.max = worldConfig.meta.gridHeight - 1;

				const wrapX = document.createElement("div");
				wrapX.appendChild(labelX);
				wrapX.appendChild(inputX);
				const wrapY = document.createElement("div");
				wrapY.appendChild(labelY);
				wrapY.appendChild(inputY);
				posWrap.appendChild(wrapX);
				posWrap.appendChild(wrapY);
				formContainer.appendChild(posWrap);

				// Couleur
				const labelColor = document.createElement("label");
				labelColor.textContent = "Couleur sur la carte";
				const inputColor = document.createElement("input");
				inputColor.type = "color";
				inputColor.value = ville.couleur || "#ffffff";
				formContainer.appendChild(labelColor);
				formContainer.appendChild(inputColor);

				// Boutons
				const btnRow = document.createElement("div");
				btnRow.style.marginTop = ".4rem";
				const btnDelete = document.createElement("button");
				btnDelete.textContent = "Supprimer la ville";
				btnDelete.type = "button";
				btnDelete.style.background = "#b71c1c";

				btnRow.appendChild(btnDelete);
				formContainer.appendChild(btnRow);

				// Événements
				inputName.addEventListener("change", () => {
					const newName = inputName.value.trim();
					if (!newName || newName === selectedCityName) {
						inputName.value = selectedCityName;
						return;
					}
					if (worldConfig.villes[newName]) {
						showMessage("Une ville porte déjà ce nom.");
						inputName.value = selectedCityName;
						return;
					}
					// Renommer la clé dans villes
					worldConfig.villes[newName] =
						worldConfig.villes[selectedCityName];
					delete worldConfig.villes[selectedCityName];

					// Mettre à jour routes
					const routes = worldConfig.routes || {};
					routes[newName] = routes[selectedCityName] || {};
					delete routes[selectedCityName];
					Object.keys(routes).forEach((other) => {
						if (routes[other][selectedCityName]) {
							routes[other][newName] = routes[other][selectedCityName];
							delete routes[other][selectedCityName];
						}
					});

					selectedCityName = newName;
					showMessage("Ville renommée.");
					renderAll();
				});

				inputX.addEventListener("change", () => {
					let v = Number(inputX.value);
					if (Number.isNaN(v)) v = 0;
					v = Math.max(0, Math.min(worldConfig.meta.gridWidth - 1, v));
					ville.x = v;
					inputX.value = v;
					recalcRoutes();
					renderMap();
				});

				inputY.addEventListener("change", () => {
					let v = Number(inputY.value);
					if (Number.isNaN(v)) v = 0;
					v = Math.max(0, Math.min(worldConfig.meta.gridHeight - 1, v));
					ville.y = v;
					inputY.value = v;
					recalcRoutes();
					renderMap();
				});

				inputColor.addEventListener("change", () => {
					ville.couleur = inputColor.value;
					renderMap();
				});

				btnDelete.addEventListener("click", () => {
					if (!confirm(`Supprimer la ville "${selectedCityName}" ?`))
						return;
					delete worldConfig.villes[selectedCityName];
					// supprimer routes associées
					if (worldConfig.routes) {
						delete worldConfig.routes[selectedCityName];
						Object.keys(worldConfig.routes).forEach((other) => {
							if (worldConfig.routes[other][selectedCityName]) {
								delete worldConfig.routes[other][selectedCityName];
							}
						});
					}
					const remaining = Object.keys(worldConfig.villes);
					selectedCityName = remaining[0] || null;
					recalcRoutes();
					renderAll();
					showMessage("Ville supprimée.");
				});
			}

			// --- Panneau ressources ----------------------------------------------
			function renderResourcesPanel() {
				const listDiv = document.getElementById("resources-list");
				clearElement(listDiv);

				worldConfig.ressources.forEach((res, index) => {
					const row = document.createElement("div");
					row.className = "resource-row";

					const input = document.createElement("input");
					input.type = "text";
					input.value = res;

					const btnUp = document.createElement("button");
					btnUp.type = "button";
					btnUp.textContent = "↑";

					const btnDown = document.createElement("button");
					btnDown.type = "button";
					btnDown.textContent = "↓";

					const btnDel = document.createElement("button");
					btnDel.type = "button";
					btnDel.textContent = "X";
					btnDel.style.background = "#b71c1c";

					row.appendChild(input);
					row.appendChild(btnUp);
					row.appendChild(btnDown);
					row.appendChild(btnDel);

					listDiv.appendChild(row);

					// événements
					input.addEventListener("change", () => {
						const newName = input.value.trim();
						if (!newName) {
							input.value = res;
							return;
						}
						// si on change le nom, il faut aussi renommer dans tous les stocks
						if (newName === res) return;

						if (worldConfig.ressources.includes(newName)) {
							showMessage("Cette ressource existe déjà.");
							input.value = res;
							return;
						}

						worldConfig.ressources[index] = newName;
						Object.values(worldConfig.villes).forEach((ville) => {
							if (!ville.stocks) ville.stocks = {};
							if (ville.stocks[newName]) return;
							if (ville.stocks[res]) {
								ville.stocks[newName] = ville.stocks[res];
								delete ville.stocks[res];
							} else {
								ville.stocks[newName] = { quantite: 0, prix: 10 };
							}
						});
						renderCitiesPanel();
					});

					btnUp.addEventListener("click", () => {
						if (index === 0) return;
						const arr = worldConfig.ressources;
						const tmp = arr[index - 1];
						arr[index - 1] = arr[index];
						arr[index] = tmp;
						renderResourcesPanel();
					});

					btnDown.addEventListener("click", () => {
						const arr = worldConfig.ressources;
						if (index >= arr.length - 1) return;
						const tmp = arr[index + 1];
						arr[index + 1] = arr[index];
						arr[index] = tmp;
						renderResourcesPanel();
					});

					btnDel.addEventListener("click", () => {
						if (!confirm(`Supprimer la ressource "${res}" ?`)) return;
						worldConfig.ressources.splice(index, 1);
						Object.values(worldConfig.villes).forEach((ville) => {
							if (ville.stocks && ville.stocks[res]) {
								delete ville.stocks[res];
							}
						});
						renderResourcesPanel();
						renderCitiesPanel();
					});
				});
			}

			// --- Panneau routes / meta -------------------------------------------
			function renderRoutesMeta() {
				const container = document.getElementById("routes-meta");
				clearElement(container);
				const meta = worldConfig.meta;

				const gridWrap = document.createElement("div");
				gridWrap.className = "inline-inputs";

				const labelGW = document.createElement("label");
				labelGW.textContent = "Largeur de la grille";
				const inputGW = document.createElement("input");
				inputGW.type = "number";
				inputGW.value = meta.gridWidth;
				inputGW.min = "4";
				inputGW.max = "80";
				const divGW = document.createElement("div");
				divGW.appendChild(labelGW);
				divGW.appendChild(inputGW);

				const labelGH = document.createElement("label");
				labelGH.textContent = "Hauteur de la grille";
				const inputGH = document.createElement("input");
				inputGH.type = "number";
				inputGH.value = meta.gridHeight;
				inputGH.min = "4";
				inputGH.max = "80";
				const divGH = document.createElement("div");
				divGH.appendChild(labelGH);
				divGH.appendChild(inputGH);

				gridWrap.appendChild(divGW);
				gridWrap.appendChild(divGH);
				container.appendChild(gridWrap);

				const timeWrap = document.createElement("div");
				timeWrap.className = "inline-inputs";

				const labelTF = document.createElement("label");
				labelTF.textContent = "Facteur temps (ms / distance)";
				const inputTF = document.createElement("input");
				inputTF.type = "number";
				inputTF.value = meta.distanceTimeFactor;
				inputTF.min = "1";

				const labelCF = document.createElement("label");
				labelCF.textContent = "Facteur coût (or / distance)";
				const inputCF = document.createElement("input");
				inputCF.type = "number";
				inputCF.value = meta.distanceCostFactor;
				inputCF.min = "0";

				const divTF = document.createElement("div");
				divTF.appendChild(labelTF);
				divTF.appendChild(inputTF);
				const divCF = document.createElement("div");
				divCF.appendChild(labelCF);
				divCF.appendChild(inputCF);

				timeWrap.appendChild(divTF);
				timeWrap.appendChild(divCF);
				container.appendChild(timeWrap);

				inputGW.addEventListener("change", () => {
					let v = Number(inputGW.value);
					if (Number.isNaN(v) || v < 4) v = 4;
					if (v > 80) v = 80;
					meta.gridWidth = v;
					inputGW.value = v;
					renderMap();
				});

				inputGH.addEventListener("change", () => {
					let v = Number(inputGH.value);
					if (Number.isNaN(v) || v < 4) v = 4;
					if (v > 80) v = 80;
					meta.gridHeight = v;
					inputGH.value = v;
					renderMap();
				});

				inputTF.addEventListener("change", () => {
					let v = Number(inputTF.value);
					if (Number.isNaN(v) || v < 1) v = 1;
					meta.distanceTimeFactor = v;
					inputTF.value = v;
				});

				inputCF.addEventListener("change", () => {
					let v = Number(inputCF.value);
					if (Number.isNaN(v) || v < 0) v = 0;
					meta.distanceCostFactor = v;
					inputCF.value = v;
				});
			}

			// --- Rendu global -----------------------------------------------------
			function renderAll() {
				ensureCityStocksFollowResources();
				renderMap();
				renderCitiesPanel();
				renderResourcesPanel();
				renderRoutesMeta();
			}

			// --- Boutons barre du haut -------------------------------------------
			function setupTopButtons() {
				const btnNew = document.getElementById("btn-new-config");
				const btnLoad = document.getElementById("btn-load-config");
				const btnSave = document.getElementById("btn-save-config");
				const btnExport = document.getElementById("btn-export-config");
				const btnAddCity = document.getElementById("btn-add-city");
				const btnAddRes = document.getElementById("btn-add-resource");
				const btnRecalcRoutes =
					document.getElementById("btn-recalc-routes");

				btnNew.addEventListener("click", () => {
					if (
						!confirm(
							"Créer une nouvelle configuration et écraser la précédente ?"
						)
					)
						return;
					worldConfig = createDefaultWorldConfig();
					recalcRoutes();
					selectedCityName = Object.keys(worldConfig.villes)[0] || null;
					renderAll();
					showMessage("Nouvelle configuration créée.");
				});

				btnLoad.addEventListener("click", () => {
					const cfg = loadWorldConfig();
					if (!cfg) {
						showMessage(
							"Aucune configuration trouvée, création d'un monde par défaut."
						);
						worldConfig = createDefaultWorldConfig();
					} else {
						worldConfig = cfg;
						if (!worldConfig.meta) {
							worldConfig.meta = {
								gridWidth: 32,
								gridHeight: 20,
								distanceTimeFactor: 400,
								distanceCostFactor: 2,
							};
						}
					}
					if (!worldConfig.routes) {
						recalcRoutes();
					}
					selectedCityName = Object.keys(worldConfig.villes)[0] || null;
					renderAll();
					showMessage("Configuration chargée.");
				});

				btnSave.addEventListener("click", () => {
					saveWorldConfig(true);
				});

				btnExport.addEventListener("click", () => {
					const blob = new Blob([JSON.stringify(worldConfig, null, 2)], {
						type: "application/json",
					});
					const url = URL.createObjectURL(blob);
					const a = document.createElement("a");
					a.href = url;
					a.download = "merchant_world_config.json";
					document.body.appendChild(a);
					a.click();
					document.body.removeChild(a);
					URL.revokeObjectURL(url);
				});

				btnAddCity.addEventListener("click", () => {
					const base = "NouvelleVille";
					const name = getUniqueCityName(base);
					const meta = worldConfig.meta;
					const newCity = {
						x: Math.floor(meta.gridWidth / 2),
						y: Math.floor(meta.gridHeight / 2),
						couleur: "#ffffff",
						stocks: {},
					};
					worldConfig.villes[name] = newCity;
					selectedCityName = name;
					ensureCityStocksFollowResources();
					recalcRoutes();
					renderAll();
					showMessage("Ville ajoutée.");
				});

				btnAddRes.addEventListener("click", () => {
					const base = "Ressource";
					let idx = worldConfig.ressources.length + 1;
					let name = base + "_" + idx;
					while (worldConfig.ressources.includes(name)) {
						idx++;
						name = base + "_" + idx;
					}
					worldConfig.ressources.push(name);
					ensureCityStocksFollowResources();
					renderResourcesPanel();
					renderCitiesPanel();
				});

				btnRecalcRoutes.addEventListener("click", () => {
					recalcRoutes();
					showMessage("Routes recalculées.");
				});
			}

			// --- Initialisation ---------------------------------------------------
			document.addEventListener("DOMContentLoaded", () => {
				worldConfig = loadWorldConfig() || createDefaultWorldConfig();
				if (!worldConfig.meta) {
					worldConfig.meta = {
						gridWidth: 32,
						gridHeight: 20,
						distanceTimeFactor: 400,
						distanceCostFactor: 2,
					};
				}
				if (
					!worldConfig.routes ||
					Object.keys(worldConfig.routes).length === 0
				) {
					recalcRoutes();
				}
				selectedCityName = Object.keys(worldConfig.villes)[0] || null;

				setupTopButtons();

				const canvas = document.getElementById("map-canvas");
				canvas.addEventListener("click", handleCanvasClick);

				renderAll();
			});
		</script>
	</body>
</html>
